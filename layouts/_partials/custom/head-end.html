{{/* 自定义CSS和JavaScript */}}
<style>
/* 宽度切换功能样式 - 增强版 */
/* 全宽状态 - 覆盖所有可能的宽度限制 */
.page-width-full .hextra-max-page-width,
.page-width-full .hextra-max-navbar-width,
.page-width-full div[class*="hx:max-w-"],
.page-width-full main[class*="hx:max-w-"],
.page-width-full article,
.page-width-full section,
.page-width-full .hx\\:max-w-6xl,
.page-width-full .hx\\:max-w-screen-xl,
.page-width-full .hx\\:max-w-7xl,
.page-width-full .hx\\:max-w-full {
  max-width: none !important;
}

/* 使用属性选择器覆盖所有Tailwind max-width类 */
.page-width-full [class*="max-w-"],
.page-width-full [class*="hx:max-w-"] {
  max-width: none !important;
}

/* 特别针对Hextra主题的容器 */
.page-width-full .hextra-max-page-width,
.page-width-full .hextra-max-navbar-width {
  max-width: none !important;
}

/* 针对具体的页面布局容器 */
.page-width-full div.hx\\:mx-auto,
.page-width-full div.hx\\:flex.hx\\:flex-col,
.page-width-full div.hx\\:w-full {
  max-width: none !important;
}

/* 使用更通用的选择器 */
.page-width-full > *,
.page-width-full * {
  max-width: none !important;
}

/* 但是保留一些元素的宽度限制 */
.page-width-full img,
.page-width-full video,
.page-width-full iframe,
.page-width-full .hextra-toc,
.page-width-full .sidebar,
.page-width-full button,
.page-width-full input,
.page-width-full select,
.page-width-full textarea {
  max-width: revert !important;
}
.page-width-full input,
.page-width-full select,
.page-width-full textarea {
  max-width: revert !important;
}

/* 宽度切换按钮样式 */
#width-switcher {
  transition: all 0.2s ease;
  position: relative;
}

#width-switcher:hover {
  background-color: rgba(0, 0, 0, 0.05);
  transform: scale(1.05);
}

.dark #width-switcher:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

/* 图标切换动画 */
#width-switcher svg {
  transition: opacity 0.2s ease, transform 0.2s ease;
}

#width-switcher:hover svg {
  transform: scale(1.1);
}

/* 页面宽度过渡动画 */
* {
  transition: max-width 0.3s ease-in-out;
}

/* 页脚样式优化 */
.hextra-footer {
  margin-top: auto;
}

/* 响应式设计 - 确保在不同屏幕尺寸下都能正常显示 */
@media (max-width: 768px) {
  .hextra-footer {
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  .hextra-footer .hextra-max-footer-width {
    padding-left: 1rem;
    padding-right: 1rem;
  }
}

@media (max-width: 480px) {
  .hextra-footer {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
  }
  
  .hextra-footer .hextra-max-footer-width {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
  }
}

/* 页面导航样式优化 */
.page-navigation {
  border-top: 1px solid #e5e7eb;
  padding-top: 2rem;
  margin-top: 3rem;
}

.dark .page-navigation {
  border-top-color: #374151;
}

.page-nav-link {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1.25rem;
  border-radius: 0.75rem;
  transition: all 0.2s ease-in-out;
  text-decoration: none;
  border: 1px solid #e5e7eb;
  background-color: #f9fafb;
  min-height: 80px;
  max-width: 300px;
}

.dark .page-nav-link {
  border-color: #374151;
  background-color: #1f2937;
}

.page-nav-link:hover {
  background-color: #f3f4f6;
  border-color: #d1d5db;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.dark .page-nav-link:hover {
  background-color: #374151;
  border-color: #4b5563;
  box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
}

/* 上一页样式 - 左对齐 */
.page-nav-prev {
  margin-right: auto;
}

/* 下一页样式 - 右对齐 */
.page-nav-next {
  margin-left: auto;
}

.page-nav-content {
  display: flex;
  flex-direction: column;
  min-width: 0;
  flex: 1;
}

.page-nav-label {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #6b7280;
  margin-bottom: 0.5rem;
}

.dark .page-nav-label {
  color: #9ca3af;
}

.page-nav-title {
  font-size: 1rem;
  font-weight: 500;
  color: #1f2937;
  line-height: 1.4;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
}

.dark .page-nav-title {
  color: #f9fafb;
}

/* 移动端优化 */
@media (max-width: 768px) {
  .page-navigation {
    margin-top: 2rem;
    padding-top: 1.5rem;
  }
  
  .page-nav-link {
    padding: 1rem;
    min-height: 70px;
  }
  
  .page-nav-title {
    font-size: 0.875rem;
  }
}

@media (max-width: 640px) {
  .page-nav-link {
    padding: 0.875rem;
    gap: 0.5rem;
  }
  
  .page-nav-title {
    font-size: 0.8rem;
  }
  
  .page-nav-label {
    font-size: 0.7rem;
    margin-bottom: 0.25rem;
  }
}

/* TOC 折叠功能样式 */
.toc-content {
  transition: all 0.3s ease-in-out;
  overflow: hidden;
}

.toc-content.collapsed {
  max-height: 0;
  opacity: 0;
  margin-top: 0;
}

.toc-chevron {
  transition: transform 0.2s ease-in-out;
}

.toc-chevron.rotated {
  transform: rotate(-180deg);
}

.toc-toggle:hover {
  color: #374151;
}

.dark .toc-toggle:hover {
  color: #d1d5db;
}

/* TOC 子目录折叠功能样式 - 点击标题版本 */
.toc-collapsible-link {
  position: relative;
  padding-right: 20px !important;
  transition: all 0.2s ease;
}

.toc-collapsible-link:hover {
  background-color: rgba(0, 0, 0, 0.05);
  border-radius: 4px;
  padding-left: 4px;
  padding-right: 24px !important;
}

.dark .toc-collapsible-link:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

.toc-section-chevron {
  transition: transform 0.2s ease;
  pointer-events: none; /* 防止箭头阻止点击事件 */
}

/* 为有子标题的链接添加视觉提示 */
.toc-collapsible-link::before {
  content: '';
  position: absolute;
  left: -8px;
  top: 50%;
  transform: translateY(-50%);
  width: 2px;
  height: 0;
  background-color: currentColor;
  opacity: 0;
  transition: all 0.2s ease;
}

.toc-collapsible-link:hover::before {
  height: 60%;
  opacity: 0.3;
}

/* 远程代码折叠功能样式 */
.code-content-wrapper {
  transition: max-height 0.3s ease-in-out;
  overflow: hidden;
}

.code-content-wrapper.collapsed {
  max-height: 300px;
}

.code-content-wrapper.expanded {
  max-height: none;
}

/* 修复代码行间距过大的问题 - 使用更紧凑的样式 */
.remote-code-container .highlight,
.remote-code-container .highlight pre,
.remote-code-container .chroma,
.remote-code-container .chroma .line,
.remote-code-container .chroma .line .cl,
.remote-code-container .code-content {
  line-height: 1.2 !important;
}

.remote-code-container .chroma .line,
.remote-code-container .chroma .line .cl {
  margin: 0 !important;
  padding: 0 !important;
  display: block !important;
}

.remote-code-container .highlight pre {
  padding: 45px 1rem 1rem 1rem !important;
  line-height: 1.2 !important;
}

.code-collapse-container {
  z-index: 10;
}

.code-collapse-btn {
  background-color: rgba(59, 130, 246, 0.15) !important;
  border-color: rgba(59, 130, 246, 0.3) !important;
  min-width: 40px !important;
  text-align: center !important;
}

.code-collapse-btn:hover {
  background-color: rgba(59, 130, 246, 0.25) !important;
  border-color: rgba(59, 130, 246, 0.4) !important;
}

.code-collapse-btn .expand-icon,
.code-collapse-btn .collapse-icon {
  color: rgba(59, 130, 246, 0.8) !important;
  font-weight: 600 !important;
}

/* 为折叠状态添加视觉提示 */
.code-content-wrapper.collapsed {
  border-bottom: 2px dashed rgba(59, 130, 246, 0.3);
}

/* 渐变遮罩效果 */
.code-content-wrapper.collapsed::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: linear-gradient(transparent, rgba(248, 249, 250, 0.95));
  pointer-events: none;
  z-index: 1;
}

.dark .code-content-wrapper.collapsed::after {
  background: linear-gradient(transparent, rgba(13, 17, 23, 0.95));
}
</style>

<script>
// 测试函数 - 确保JavaScript正常加载
console.log('TOC JavaScript loaded successfully');

// 处理TOC标题点击事件
function handleTOCClick(event, link) {
  console.log('handleTOCClick called', link);
  
  // 检查是否有子标题
  const hasChildren = link.getAttribute('data-has-children') === 'true';
  
  if (hasChildren) {
    // 阻止默认的锚点跳转行为
    event.preventDefault();
    
    const section = link.closest('.toc-section');
    if (!section) {
      console.log('No section found');
      return;
    }
    
    const content = section.querySelector('.toc-section-content');
    const chevron = link.querySelector('.toc-section-chevron');
    
    if (!content || !chevron) {
      console.log('Content or chevron not found', content, chevron);
      return;
    }
    
    // 切换显示/隐藏
    if (content.style.display === 'none') {
      content.style.display = 'block';
      chevron.style.transform = 'translateY(-50%) rotate(0deg)';
      console.log('Showing content');
    } else {
      content.style.display = 'none';
      chevron.style.transform = 'translateY(-50%) rotate(-180deg)';
      console.log('Hiding content');
    }
    
    // 保存状态
    const sectionId = section.getAttribute('data-section-id');
    if (sectionId) {
      const isCollapsed = content.style.display === 'none';
      const collapsedSections = JSON.parse(localStorage.getItem('tocCollapsedSections') || '{}');
      collapsedSections[sectionId] = isCollapsed;
      localStorage.setItem('tocCollapsedSections', JSON.stringify(collapsedSections));
      console.log('Saved state for', sectionId, isCollapsed);
    }
  } else {
    // 没有子标题，正常跳转到锚点
    console.log('Normal anchor navigation');
  }
}

// 页面加载时恢复状态和加载远程代码
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, restoring TOC states and loading remote code');
  
  // 恢复页面宽度设置
  const savedWidth = localStorage.getItem('pageWidth') || 'normal';
  const body = document.body;
  
  if (savedWidth === 'full') {
    body.classList.add('page-width-full');
    console.log('Restored full width');
  } else {
    body.classList.remove('page-width-full');
    console.log('Restored normal width');
  }
  
  // TOC 状态恢复
  const sections = document.querySelectorAll('.toc-section');
  console.log('Found TOC sections:', sections.length);
  
  const collapsedSections = JSON.parse(localStorage.getItem('tocCollapsedSections') || '{}');
  console.log('Collapsed sections from storage:', collapsedSections);
  
  sections.forEach(section => {
    const sectionId = section.getAttribute('data-section-id');
    const content = section.querySelector('.toc-section-content');
    const chevron = section.querySelector('.toc-section-chevron');
    
    console.log('Processing section:', sectionId, content, chevron);
    
    if (sectionId && content && chevron && collapsedSections[sectionId]) {
      content.style.display = 'none';
      chevron.style.transform = 'translateY(-50%) rotate(-180deg)';
      console.log('Restored collapsed state for', sectionId);
    }
  });
  
  // 远程代码加载
  console.log('Remote code JavaScript loaded');
  const containers = document.querySelectorAll('.remote-code-container');
  console.log('Found remote code containers:', containers.length);
  
  containers.forEach(container => {
    loadRemoteCodeContent(container);
  });
});

// 宽度切换功能 - 增强版
function togglePageWidth() {
  const body = document.body;
  
  if (body.classList.contains('page-width-full')) {
    // 切换到正常宽度
    body.classList.remove('page-width-full');
    localStorage.setItem('pageWidth', 'normal');
    console.log('Switched to normal width');
  } else {
    // 切换到全宽
    body.classList.add('page-width-full');
    localStorage.setItem('pageWidth', 'full');
    console.log('Switched to full width');
  }
  
  // 强制重新计算布局
  document.body.style.display = 'none';
  document.body.offsetHeight; // 触发重排
  document.body.style.display = '';
  
  // 触发窗口resize事件，让其他组件重新计算尺寸
  window.dispatchEvent(new Event('resize'));
}

// 现有的滚动到顶部功能
function scrollUp() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// 滚动监听，显示/隐藏返回顶部按钮
window.addEventListener('scroll', function() {
  const backToTop = document.getElementById('backToTop');
  if (backToTop) {
    if (window.pageYOffset > 300) {
      backToTop.style.opacity = '1';
    } else {
      backToTop.style.opacity = '0';
    }
  }
});

// 远程代码加载功能 - 简化版本
async function loadRemoteCodeContent(container) {
  const url = container.dataset.url;
  const lang = container.dataset.lang || 'text';
  
  console.log('Loading remote code from:', url);
  
  const loadingState = container.querySelector('.loading-state');
  const errorState = container.querySelector('.error-state');
  const codeDisplay = container.querySelector('.code-display');
  const codeContent = container.querySelector('.code-content');
  const errorMessage = container.querySelector('.error-message');
  
  if (!loadingState || !errorState || !codeDisplay || !codeContent || !errorMessage) {
    console.error('Missing required elements in container');
    return;
  }
  
  try {
    console.log('开始加载代码:', url);
    
    // 尝试直接获取
    let response;
    try {
      response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (directError) {
      console.log('直接获取失败，尝试使用代理...');
      const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      response = await fetch(proxyUrl);
      if (!response.ok) {
        throw new Error(`代理请求失败: HTTP ${response.status}`);
      }
    }
    
    let codeText = await response.text();
    console.log('Code text length:', codeText.length);
    
    // 基本清理
    codeText = codeText.replace(/^\uFEFF/, ''); // 移除 BOM
    codeText = codeText.replace(/\r\n/g, '\n').replace(/\r/g, '\n'); // 统一换行符
    
    if (!codeText.trim()) {
      throw new Error('代码内容为空');
    }
    
    // 将代码按行分割并包装成Hextra的格式
    const codeLines = codeText.split('\n');
    const formattedCode = codeLines.map((line, index) => {
      const escapedLine = line
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      
      return `<span class="line"><span class="cl">${escapedLine}</span></span>`;
    }).join('\n');
    
    // 显示代码
    codeContent.innerHTML = formattedCode;
    codeContent.setAttribute('data-raw-code', codeText);
    
    // 直接设置行间距样式 - 更紧凑的样式，并调整padding
    setTimeout(() => {
      const lines = codeContent.querySelectorAll('.line');
      const pre = codeContent.closest('pre');
      const highlight = codeContent.closest('.highlight');
      
      // 设置整体容器样式 - 更紧凑，顶部padding为按钮留空间
      if (pre) {
        pre.style.setProperty('line-height', '1.2', 'important');
        pre.style.setProperty('padding', '45px 1rem 1rem 1rem', 'important');
      }
      
      if (highlight) {
        highlight.style.setProperty('line-height', '1.2', 'important');
      }
      
      // 设置每一行的样式 - 更紧凑
      lines.forEach(line => {
        line.style.setProperty('line-height', '1.2', 'important');
        line.style.setProperty('margin', '0', 'important');
        line.style.setProperty('padding', '0', 'important');
        line.style.setProperty('display', 'block', 'important');
        
        const cl = line.querySelector('.cl');
        if (cl) {
          cl.style.setProperty('line-height', '1.2', 'important');
          cl.style.setProperty('display', 'block', 'important');
          cl.style.setProperty('margin', '0', 'important');
          cl.style.setProperty('padding', '0', 'important');
        }
      });
      
      // 设置code元素本身的样式
      codeContent.style.setProperty('line-height', '1.2', 'important');
      codeContent.style.setProperty('display', 'block', 'important');
    }, 50);
    
    // 检查代码行数，如果超过20行则显示折叠功能
    const lineCount = codeLines.length;
    const collapseContainer = codeDisplay.querySelector('.code-collapse-container');
    const contentWrapper = codeDisplay.querySelector('.code-content-wrapper');
    
    if (lineCount > 20 && collapseContainer && contentWrapper) {
      // 显示折叠控制
      collapseContainer.classList.remove('hidden');
      
      // 初始状态为折叠
      contentWrapper.classList.add('collapsed');
      contentWrapper.style.position = 'relative';
      
      // 添加折叠按钮事件
      const collapseBtn = codeDisplay.querySelector('.code-collapse-btn');
      if (collapseBtn) {
        collapseBtn.addEventListener('click', function() {
          const isCollapsed = contentWrapper.classList.contains('collapsed');
          const expandIcon = collapseBtn.querySelector('.expand-icon');
          const collapseIcon = collapseBtn.querySelector('.collapse-icon');
          
          if (isCollapsed) {
            // 展开
            contentWrapper.classList.remove('collapsed');
            contentWrapper.classList.add('expanded');
            expandIcon.classList.add('hidden');
            collapseIcon.classList.remove('hidden');
            collapseBtn.title = '折叠代码';
          } else {
            // 折叠
            contentWrapper.classList.remove('expanded');
            contentWrapper.classList.add('collapsed');
            expandIcon.classList.remove('hidden');
            collapseIcon.classList.add('hidden');
            collapseBtn.title = '展开代码';
          }
        });
        
        // 设置初始状态 - 折叠时显示展开图标
        const expandIcon = collapseBtn.querySelector('.expand-icon');
        const collapseIcon = collapseBtn.querySelector('.collapse-icon');
        expandIcon.classList.remove('hidden');
        collapseIcon.classList.add('hidden');
        collapseBtn.title = '展开代码';
      }
    }
    
    // 切换显示状态
    loadingState.style.display = 'none';
    errorState.style.display = 'none';
    codeDisplay.style.display = 'block';
    
    // 添加复制按钮
    setTimeout(() => {
      const codeBlock = codeDisplay.querySelector('.hextra-code-block');
      if (codeBlock && !codeBlock.querySelector('.hextra-code-copy-btn-container')) {
        addCopyButton(codeBlock, codeContent);
      }
    }, 100);
    
    console.log('代码加载成功');
    
  } catch (error) {
    console.error('代码加载失败:', error);
    
    loadingState.style.display = 'none';
    codeDisplay.style.display = 'none';
    errorState.style.display = 'block';
    errorMessage.textContent = `错误: ${error.message}`;
  }
}

function addCopyButton(codeBlock, codeContent) {
  console.log('Adding copy button');
  
  const copyContainer = document.createElement('div');
  copyContainer.className = 'hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0';
  
  const copyButton = document.createElement('button');
  copyButton.className = 'hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50';
  copyButton.title = 'Copy code';
  
  // 添加图标
  copyButton.innerHTML = `
    <div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
      </svg>
    </div>
    <div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
      </svg>
    </div>
  `;
  
  // 添加复制功能
  copyButton.addEventListener('click', function() {
    const rawCode = codeContent.getAttribute('data-raw-code') || codeContent.textContent;
    
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(rawCode).then(() => {
        copyButton.classList.add('copied');
        setTimeout(() => copyButton.classList.remove('copied'), 2000);
      });
    } else {
      // 降级方法
      const textarea = document.createElement('textarea');
      textarea.value = rawCode;
      textarea.style.position = 'fixed';
      textarea.style.left = '-999999px';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      copyButton.classList.add('copied');
      setTimeout(() => copyButton.classList.remove('copied'), 2000);
    }
  });
  
  copyContainer.appendChild(copyButton);
  codeBlock.appendChild(copyContainer);
}
</script>